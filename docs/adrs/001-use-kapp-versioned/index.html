<!doctype html>
<html>
  <head>
    


<meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="1. Use kapp versioned annotation Date: 2020-05-08
[Tracker ID: #167379966] https://www.pivotaltracker.com/story/show/172597153 https://www.pivotaltracker.com/story/show/172597361…"/>
<link rel="canonical" content="https://cf-for-k8s.io/docs/adrs/001-use-kapp-versioned/">
<link rel="icon" type="image/png" href="/images/favicon.png">






<meta property="og:title" content=" · Cloud Foundry for Kubernetes">
<meta property="og:type" content="website">
<meta property="og:url" content="https://cf-for-k8s.io/docs/adrs/001-use-kapp-versioned/">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Cloud Foundry for Kubernetes">
<meta property="og:description" content="1. Use kapp versioned annotation Date: 2020-05-08
[Tracker ID: #167379966] https://www.pivotaltracker.com/story/show/172597153 https://www.pivotaltracker.com/story/show/172597361…">
<meta property="og:type" content="article">
<meta property="og:image" content="https://cf-for-k8s.io/images/logo-large.svg">
<meta property="og:image:alt" content="CF for K8s project logo">
<meta property="og:image:type" content="image/jpeg">






<meta property="twitter:title" content=" · Cloud Foundry for Kubernetes">
<meta property="twitter:card" content="summary">
<meta property="twitter:image" content="https://cf-for-k8s.io/images/logo.svg">
<meta property="twitter:image:alt" content="CF for K8s project logo">
<meta property="twitter:site" content="@">
<meta property="twitter:creator" content="@">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css?family=Fira+Mono|Source+Sans+Pro:400,400i,600" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cf-for-k8s.io/scss/site.css" integrity="" media="screen">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">

    
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-PVB2G57');</script>
    

    <script>
      function addAnchor(element) {
        if (element.id === "" || element.getElementsByTagName("a").length > 0) {
          return;
        }

        


        element.innerHTML =
        `${element.innerHTML}`;
      }

      document.addEventListener('DOMContentLoaded', function () {
        const headers = document.querySelectorAll('h1, h2, h3, h4, h5');
        if (headers) {
          headers.forEach(addAnchor);
        }
      });
    </script>

    <title> · Cloud Foundry for Kubernetes</title>
  </head>
  <body>
    
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PVB2G57"
      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    
    <header class="container">
  <a href="https://cf-for-k8s.io/" class="logo"><img src="/images/logo.svg" alt="CF For K8s Logo"></a>
  <input type="checkbox" id="mobile-nav-toggle">
  <label for="mobile-nav-toggle"></label>
  <ul>
    
    
      
      <li><a class=""  href="/">Home</a></li>
    
      
      <li><a class=""  href="/features/">Features</a></li>
    
      
      <li><a class="active"  href="/docs/">Docs</a></li>
    
      
      <li><a class="" target='_blank' href="https://medium.com/@cf-release-integration">Blog</a></li>
    
    <li><a href="https://github.com/cloudfoundry/cf-for-k8s" class="github-button icon-button bg-blue button">GitHub</a></li>
  </ul>
</header>

    

<div class='docs'>
  <div class="container">
    <div class='row'>
      <div class='col-md-4 docs-sidebar'>
        <nav class='sidebar'>
  <ul>
      <li data-nav-id="/docs/" class="dd-item depth-0">
        <a href="/docs/">Getting Started with Cf-for-K8s</a>
        <ul class="ml-2">
        </ul>
      </li>
      <li data-nav-id="/docs/deploying/" class="dd-item depth-0 haschildren">
        <a href="/docs/deploying/">Deploying cf-for-k8s</a>
          <ul class="ml-2">
      <li data-nav-id="/docs/deploying/deploy-local/" class="dd-item depth-1">
        <a href="/docs/deploying/deploy-local/">Deploying CF for K8s Locally</a>
      </li>
      <li data-nav-id="/docs/deploying/deploy-in-ci/" class="dd-item depth-1">
        <a href="/docs/deploying/deploy-in-ci/">Deploy CF for K8s in CI</a>
      </li>
          </ul>
      </li>
      <li data-nav-id="/docs/platform_operators/" class="dd-item depth-0 haschildren">
        <a href="/docs/platform_operators/">Extend cf-for-k8s</a>
          <ul class="ml-2">
      <li data-nav-id="/docs/platform_operators/deploy-parameters/" class="dd-item depth-1">
        <a href="/docs/platform_operators/deploy-parameters/">Deploy Parameters</a>
      </li>
      <li data-nav-id="/docs/platform_operators/gateway-access-logs/" class="dd-item depth-1">
        <a href="/docs/platform_operators/gateway-access-logs/">Gateway Access Logs</a>
      </li>
      <li data-nav-id="/docs/platform_operators/ingress-routing-topology/" class="dd-item depth-1">
        <a href="/docs/platform_operators/ingress-routing-topology/">Ingress Routing</a>
      </li>
      <li data-nav-id="/docs/platform_operators/warning-regarding-kubectl-usage/" class="dd-item depth-1">
        <a href="/docs/platform_operators/warning-regarding-kubectl-usage/">kubectl Warning</a>
      </li>
      <li data-nav-id="/docs/platform_operators/networking-metrics/" class="dd-item depth-1">
        <a href="/docs/platform_operators/networking-metrics/">Networking Metrics</a>
      </li>
      <li data-nav-id="/docs/platform_operators/rotating-secrets-and-certs/" class="dd-item depth-1">
        <a href="/docs/platform_operators/rotating-secrets-and-certs/">Rotating Secrets</a>
      </li>
      <li data-nav-id="/docs/platform_operators/setup-static-loadbalancer-ip/" class="dd-item depth-1">
        <a href="/docs/platform_operators/setup-static-loadbalancer-ip/">Setup a static IP for loadbalancer</a>
      </li>
      <li data-nav-id="/docs/platform_operators/setup-ingress-certs-with-letsencrypt/" class="dd-item depth-1">
        <a href="/docs/platform_operators/setup-ingress-certs-with-letsencrypt/">Setup ingress certs with Lets Encrypt</a>
      </li>
      <li data-nav-id="/docs/platform_operators/sidecar-access-logs/" class="dd-item depth-1">
        <a href="/docs/platform_operators/sidecar-access-logs/">Sidecar Access Logs</a>
      </li>
      <li data-nav-id="/docs/platform_operators/external-blobstore/" class="dd-item depth-1">
        <a href="/docs/platform_operators/external-blobstore/">Using external blobstore</a>
      </li>
      <li data-nav-id="/docs/platform_operators/external-databases/" class="dd-item depth-1">
        <a href="/docs/platform_operators/external-databases/">Using external databases</a>
      </li>
          </ul>
      </li>
      <li data-nav-id="/docs/contributing/" class="dd-item depth-0">
        <a href="/docs/contributing/">Contributing <br>(for Component Developers)</a>
      </li>
      <li data-nav-id="/docs/debugging/" class="dd-item depth-0">
        <a href="/docs/debugging/">Debugging</a>
      </li>
      <li data-nav-id="/docs/maintaining/" class="dd-item depth-0">
        <a href="/docs/maintaining/">Maintaining <br>(for Release Integration Engineers)</a>
      </li>
    </ul>
  
</nav>



      </div>
      <div class='col-md-8 docs-content'>
        <div class="support-links">
  
    
    
    <a href="https://github.com/cloudfoundry/cf-for-k8s-docs/issues/new?body=%2A%2AOn&#43;Page%3A%2A%2A&#43;%5B%5D%28https%3A%2F%2Fcf-for-k8s.io%2Fdocs%2Fadrs%2F001-use-kapp-versioned%2F%29"
       class="btn-light blue-text btn-small icon-button blank inline-flex" target="_blank">Report Issues</a>

    
    
    <a href="https://github.com/cloudfoundry/cf-for-k8s-docs/edit/main/content/docs/adrs/001-use-kapp-versioned.md?description=Signed-off-by%3A&#43;NAME&#43;%3CEMAIL_ADDRESS%3E%0A%0A%3E&#43;_By&#43;signing&#43;off&#43;you&#43;acknowledge&#43;adhering&#43;to&#43;the&#43;requirements&#43;listed&#43;here%3A&#43;https%3A%2F%2Fprobot.github.io%2Fapps%2Fdco%2F_"
       class="btn-light blue-text btn-small icon-button github-button inline-flex" target="_blank">Edit</a>
    
  
</div>


        <div class="heading">
          <h1 class="title"></h1>
        </div>

        <h1 id="1-use-kapp-versioned-annotation">1. Use kapp versioned annotation</h1>
<p>Date: 2020-05-08</p>
<p>[Tracker ID: <a href="https://www.pivotaltracker.com/story/show/167379966">#167379966</a>]
<a href="https://www.pivotaltracker.com/story/show/172597153">https://www.pivotaltracker.com/story/show/172597153</a>
<a href="https://www.pivotaltracker.com/story/show/172597361">https://www.pivotaltracker.com/story/show/172597361</a>
<a href="https://www.pivotaltracker.com/story/show/172724542">https://www.pivotaltracker.com/story/show/172724542</a></p>
<h2 id="status">Status</h2>
<p>Accepted</p>
<h2 id="context">Context</h2>
<p>As we look to support the rotation of configuration and credentials in cf-for-k8s,
we have considered the potential challenges of a kubernetes-native implementation. At
some point in the chain from kubernetes resources to the processes running in pods, we need
to update a value and have that value flow into the running processes by which it
is consumed.</p>
<p>As an initial callout, we have the following underlying assumption:
hardcoding the value of a secret into config and updating it there is not a secure solution.
Instead we would like to capture configuration and values in kubernetes
primitives, ConfigMaps and Secrets, and only consume references to those resources.
Consequently our only option for updating the value itself is to update the ConfigMap or Secret.
This leaves the question of how we update all of the consumers of those resources?</p>
<h3 id="examples-to-illustrate-our-assumption-and-the-top-level-update-mechanism">Examples to illustrate our assumption and the top level update mechanism</h3>
<h4 id="hardcoded-insecure-examples">Hardcoded insecure examples:</h4>
<p>kind: ConfigMap
metadata:
name: my-insecure-configmap
hardcoded-secret: my-other-secret</p>
<p>kind: Pod
env:
name: hardcoded-secret
value: my-secret
volumeMounts:</p>
<ul>
<li>name: config-vol
mountPath: /etc/config
volumes:</li>
<li>name: config-vol
configMap:
name: my-insecure-configmap
items:
<ul>
<li>key: hardcoded-secret
path: hardcoded-secret</li>
</ul>
</li>
</ul>
<p>An update mechanism would be responsible for finding every instance of the
secret values: &lsquo;my-secret&rsquo; and &lsquo;my-other-secret&rsquo; and updating them directly in
plaintext on the kubernetes resources yaml.</p>
<h4 id="secure-reference-example">Secure reference example:</h4>
<p>kind: Secret
metadata:
name: secure-example
stringData: my-secure-secret</p>
<p>kind: Pod
volumeMounts:</p>
<ul>
<li>name: config-vol
mountPath: /etc/config
volumes:</li>
<li>name: secure-secret
secret:
name: secure-example</li>
</ul>
<p>An update mechanism would now only be responsible for updating the kubernetes
Secret value directly.</p>
<h3 id="propagating-the-updated-value-in-both-cases">Propagating the updated value in both cases:</h3>
<p>An update mechanism would be responsible for finding every runtime use of the
secret reference and triggering the value to update. The cluster kubelet handles
the update of secrets on containers on some configurable interval for instance.</p>
<p>We could take advantage of the standard kubernetes initialization
lifecycle to both update and load the updated secret by restarting the running containers with a
pod update or something of that nature. Alternatively, the runtime itself could
be responsible for detecting changes to the mounted secrets and reloading after
the kubelet periodically remounts the volumes with updated contents.</p>
<h3 id="intermediate-references">Intermediate References:</h3>
<p>In some cases, Secrets and ConfigMaps are referred to by other resources above
the pod/container level. If we happen to be updating the reference
itself, we would also need a mechanism for updating every consuming resource with a
reference to the original resource.</p>
<h2 id="decision">Decision</h2>
<p>Use kapp and the kapp versioned annotation to manage the update of all Secrets and
ConfigMaps in cf-for-k8s.</p>
<p>See <a href="https://github.com/k14s/kapp/blob/ebed3116baac6a0e414648e6a93d3cc946c7fe91/docs/diff.md#versioned-resources">https://github.com/k14s/kapp/blob/ebed3116baac6a0e414648e6a93d3cc946c7fe91/docs/diff.md#versioned-resources</a></p>
<h2 id="consequences">Consequences</h2>
<p>By default, kapp is configured to detect all references to Secrets and
ConfigMaps in the core Kubernetes API resources. (And if any are missing, please
PR them into the default kapp templateRules). For all CRDs with references to
Secrets and Configmaps, we need to add a custom templateRule entry matching
the resource and the path to the reference within that resource.</p>


        

        <hr>
<div class='footline d-block'>
  <div class="support-links">
  
    
    
    <a href="https://github.com/cloudfoundry/cf-for-k8s-docs/issues/new?body=%2A%2AOn&#43;Page%3A%2A%2A&#43;%5B%5D%28https%3A%2F%2Fcf-for-k8s.io%2Fdocs%2Fadrs%2F001-use-kapp-versioned%2F%29"
       class="btn-light blue-text btn-small icon-button blank inline-flex" target="_blank">Report Issues</a>

    
    
    <a href="https://github.com/cloudfoundry/cf-for-k8s-docs/edit/main/content/docs/adrs/001-use-kapp-versioned.md?description=Signed-off-by%3A&#43;NAME&#43;%3CEMAIL_ADDRESS%3E%0A%0A%3E&#43;_By&#43;signing&#43;off&#43;you&#43;acknowledge&#43;adhering&#43;to&#43;the&#43;requirements&#43;listed&#43;here%3A&#43;https%3A%2F%2Fprobot.github.io%2Fapps%2Fdco%2F_"
       class="btn-light blue-text btn-small icon-button github-button inline-flex" target="_blank">Edit</a>
    
  
</div>

</div>

      </div>
    </div>
  </div>
</div>





    <footer>
  
  <div class="bg-black">
    <div class="container footer clearfix">
      <div class="logo">
        <a href="https://cf-for-k8s.io/"><img src="/images/logo-white.svg" class="footer-logo"></a>
      </div>
      <div class="info">
        <p>cf for k8s is a Cloud Foundry Project</p>
        <p class="sub-info">Hugo template graciously copied from buildpacks.io</p>
      </div>
      <ul>
        <li><a href="https://cloudfoundry.slack.com/?redir=%2Farchives%2FCH9LF6V1P" target="_blank"><img src="/images/slack.png"></a></li>
        <li><a href="https://lists.cloudfoundry.org/g/cf-dev/topics" target="_blank"><img src="/images/mail.png"></a></li>
        <li><a href="https://twitter.com/cloudfoundry" target="_blank"><img src="/images/twitter.png"></a></li>
        <li><a href="https://github.com/cloudfoundry/cf-for-k8s" target="_blank"><img src="/images/github.png"></a></li>
      </ul>
    </div>
  </div>
</footer>

  </body>
</html>
